# SQL 智能教学系统 — 前后端功能测试文档

本文档提供后端与前端主要功能的测试步骤与预期结果，便于回归与联调。

---

## 一、环境与前置条件

- **后端**：Python 3.10+，依赖见 `sql-edu-backend/requirements.txt`；配置 `.env`（如 `DB_URL`、`JWT_SECRET_KEY`、邮件、AI API 等）。
- **前端**：Node 18+，`npm install` 后 `npm run dev:h5`；请求 baseURL 指向后端（如 `http://localhost:8000` 或配置的 API 地址）。
- **数据库**：已执行 `alembic upgrade head`；具备测试用邮箱（用于验证码）及可选教师邀请码。

---

## 二、后端接口测试

### 1. 健康检查

```bash
curl -s http://localhost:8000/
# 预期：{"message":"SQL 智能教学系统后端运行中"}
```

---

### 2. 认证

- **发送验证码**  
  `GET /auth/code?email=你的邮箱`  
  预期：`{"result":"success"}`，邮箱收到 6 位验证码。

- **注册**  
  `POST /auth/register`  
  Body 示例：`{"email":"test@example.com","username":"test","password":"test123","confirm_password":"test123","captcha":"收到的6位码","invite_code":""}`  
  预期：`{"result":"success"}`。

- **登录**  
  `POST /auth/login`  
  Body：`{"email":"test@example.com","password":"test123"}`  
  预期：返回 `access_token`、`refresh_token` 等。

- **获取当前用户**  
  `GET /auth/profile`  
  Header：`Authorization: Bearer <access_token>`  
  预期：返回用户信息、等级、经验等。

---

### 3. 题目

- **题目列表（需登录）**  
  `GET /questions/?skip=0&limit=10`  
  Header：`Authorization: Bearer <token>`  
  预期：题目数组，含 id、title、content、difficulty、display_difficulty、required_output_columns 等。

- **题目详情**  
  `GET /questions/1`  
  Header：同上  
  预期：单题详情，含 schema_preview（若题目有或可生成）。

- **知识点列表（需教师）**  
  `GET /questions/knowledge-points`  
  Header：教师 Token  
  预期：知识点数组，含 id、name、level、name_i18n、level_i18n 等。

- **创建题目（需教师）**  
  `POST /questions/`  
  Body：`{"title":"测试题","content":"查询所有产品","correct_sql":"SELECT * FROM products"}`  
  预期：201，返回创建的题目。

---

### 4. 判题与 AI

- **检查 SQL（需登录）**  
  `POST /ai/check-sql`  
  Body：`{"student_sql":"SELECT * FROM products","question_id":1,"language":"zh-CN"}`  
  Header：`Authorization: Bearer <token>`  
  预期：`is_correct`、`hint`、`submission_id`、`error_message` 等；若题目有 schema_preview，判题库应先建表再执行，字符串列按 strip+小写比较。

- **对话历史**  
  `GET /ai/chat/messages?question_id=1&limit=20`  
  Header：同上  
  预期：消息数组。

- **发送对话**  
  `POST /ai/chat`  
  Body：`{"question_id":1,"content":"如何限制只查前 10 条？"}`  
  预期：返回 AI 回复内容。

- **清除对话**  
  `DELETE /ai/chat/messages?question_id=1`  
  预期：返回删除条数。

---

### 5. 多语言与教师

- **生成题目多语言（已登录即可）**  
  `POST /questions/1/generate-i18n`  
  Header：`Authorization: Bearer <token>`  
  预期：200，返回更新后的题目（含 title_en、content_en、title_zh_tw、content_zh_tw）。

- **AI 生成题目（需教师）**  
  `POST /questions/generate-by-ai`  
  Body：`{"knowledge_point_id":"alias","count":1}`  
  Header：教师 Token  
  预期：201，返回新题目列表。

---

## 三、前端页面测试

### 1. 登录页（`/pages/login/index`）

| 步骤 | 操作 | 预期 |
|------|------|------|
| 1 | 打开页面 | 显示登录/注册/注销三个 Tab，右上角语言切换 |
| 2 | 切换语言 | 整页文案与导航栏标题随语言变化 |
| 3 | 注册：先请求验证码，再提交注册表单 | 收邮件验证码；提交后提示成功并切回登录 |
| 4 | 登录：输入邮箱与密码提交 | 跳转首页（学生）或教师端（教师角色） |
| 5 | 注销账户 Tab：输入邮箱与密码确认 | 提示不可逆；成功后清 Token 并切回登录 |

---

### 2. 学生练习页（`/pages/index/index`）

| 步骤 | 操作 | 预期 |
|------|------|------|
| 1 | 未登录进入 | 跳转登录页 |
| 2 | 登录后进入 | 显示题目列表、当前题目标题与内容、表结构预览区、SQL 输入区、提交按钮、对话区 |
| 3 | 切换语言为 English | 界面文案为英文；若题目无英文翻译，先显示“(Translating...)”并自动请求 generate-i18n，成功后显示英文 |
| 4 | 选题：下拉 / 题号跳转 / 随机 | 当前题目与详情更新；表结构预览随题目变化 |
| 5 | 输入正确 SQL 提交 | 判题通过，显示 AI 提示；若首次正确可弹难度反馈 |
| 6 | 输入错误 SQL 提交 | 判题不通过，显示错误信息与 AI 提示 |
| 7 | 对话：发送消息 | 收到 AI 回复并追加到对话列表 |
| 8 | 清除历史对话 | 对话列表清空 |
| 9 | 限时挑战：点击限时按钮后倒计时内提交正确 | 提示成功并可获得额外经验（若后端配置） |

---

### 3. 教师端（`/pages/teacher/index`）

| 步骤 | 操作 | 预期 |
|------|------|------|
| 1 | 非教师账号进入 | 根据当前逻辑跳转或提示无权限 |
| 2 | 教师登录后进入 | 显示题目列表、新建/编辑表单、知识点下拉、AI 生成题目、补全多语言按钮 |
| 3 | 切换语言 | 知识点与题目列表的标题/内容随语言变化 |
| 4 | 选择知识点，点击「AI 生成题目」 | 生成 1～5 道题并加入列表 |
| 5 | 选择某题，点击「补全多语言」 | 该题生成英文/繁体题面，列表与表单更新 |
| 6 | 编辑题目后保存 | 题目更新；学生端刷新后可见新内容 |
| 7 | 删除题目 | 二次确认后题目从列表移除 |

---

## 四、判题与多语言专项

- **字符串列判题**：题目表结构含 `name` 等字符串列时，学生写 `WHERE name='Laptop'` 或 `name='laptop'` 或 `name='Laptop '`，应与标准答案判为一致（后端已对字符串做 strip+小写归一化）。
- **多语言一致性**：学生端切换为 English 后，仅显示英文题面或“翻译生成中”，不出现中文题面；教师端切换语言后，列表与表单均为当前语言。

---

## 五、自动化测试（后端）

```bash
cd sql-edu-backend
pytest tests/ -v
# 可选：pytest tests/test_sql_judge.py -v
# 可选：pytest tests/test_api_integration.py -v
```

- `test_sql_judge.py`：验证 SQL 安全检查、结果标准化与对比（含有序/无序）。
- `test_api_integration.py`：需配置测试库与可选 Token，验证主要 API 请求与响应。
- `conftest.py`：提供 session、客户端等 fixture。

---

*文档版本：与当前代码一致；实际测试时请以本地环境与配置为准。*
