# SQL 智能教学系统 — 从 0 到实现的逻辑链


---

## 一、整体架构与依赖顺序

```
数据库(MySQL) ← Alembic 迁移
     ↑
  SQLAlchemy 模型 (models/) + 仓库 (repository/)
     ↑
  业务逻辑 (core/) + 路由 (routers/)
     ↑
  FastAPI 应用 (main.py) ← CORS / 依赖注入 (dependencies.py)
     ↑
  前端 uni-app (Vue3) ← request 封装 (utils/request.ts) + API 模块 (api/)
     ↑
  页面 (pages/)：登录 → 学生练习 / 教师端
```

建议实现顺序：**数据库与模型 → 认证 → 题目 CRUD → 判题与 AI → 前端页面与联调**。

---

## 二、后端逻辑链

### 1. 数据库与模型（从 0 建表）

1. **配置**：`settings/config.py` 中 `DB_URL`（MySQL 连接串）。
2. **模型**：`models/base.py` 定义基类；`models/user.py`、`models/question.py`、`models/submission.py`、`models/chat.py`、`models/question_feedback.py`、`models/auth.py`（邮箱验证码等）定义表结构。
3. **迁移**：`alembic/versions/` 下按时间顺序的迁移脚本；执行 `alembic upgrade head` 建表/加列。
4. **依赖**：`dependencies.py` 中 `get_session()` 提供异步会话，供所有路由使用。

**逻辑链**：`DB_URL` → 创建引擎与会话 → 模型与仓库在会话上执行 SQL。

---

### 2. 认证（注册 / 登录 / Token）

1. **发送验证码**：`GET /auth/code?email=xxx` → `EmailCodeRepository` 写入验证码 → `FastMail` 发邮件。
2. **注册**：`POST /auth/register` → 校验验证码 → 密码哈希（如 bcrypt）→ `UserRepository` 创建用户；可选教师邀请码写入角色。
3. **登录**：`POST /auth/login` → 校验邮箱/用户名与密码 → `AuthHandler` 生成 access_token、refresh_token → 返回前端。
4. **刷新 Token**：`POST /auth/refresh` → 校验 refresh_token → 签发新 access_token。
5. **获取当前用户**：`GET /auth/profile` → `AuthHandler` 解析 Bearer Token → `UserRepository` 查用户 → 计算等级与经验（`core/experience_service.py`）→ 返回 profile。

**逻辑链**：邮箱验证码 → 注册/登录 → JWT 签发与校验 → 后续请求均带 Token 访问受保护接口。

---

### 3. 题目管理（CRUD + 知识点 + AI 生成）

1. **题目列表**：`GET /questions/` → `QuestionRepository.get_all` → 对每题批量查提交数、正确数、聊天数、难度反馈 → `compute_display_difficulty`、`suggested_time_seconds`、`infer_output_columns_from_sql`（缺 required_output_columns 时）→ 返回 `QuestionOut` 列表。
2. **题目详情**：`GET /questions/{id}` → `get_by_id` → 若无 schema_preview 则调用 AI 生成并落库 → 同上动态字段填充 → 返回单题。
3. **创建/更新题目**：`POST/PUT /questions/` → 校验教师权限 → 难度/限时/结果列名留空时由 `infer_difficulty_from_question`、`infer_output_columns_from_sql` 等填充 → 写入或更新 `questions` 表。
4. **知识点列表**：`GET /questions/knowledge-points` → `core/sql_knowledge_points.get_all_knowledge_points()` → 返回静态知识点（含 name_i18n/level_i18n 等）。
5. **AI 生成题目**：`POST /questions/generate-by-ai` → `get_knowledge_point_by_id` → `generate_questions_for_knowledge_point`（调用 AI）→ 解析 JSON 得到多道题（含多语言字段）→ 逐条插入 `questions` 并返回。
6. **生成多语言题面**：`POST /questions/{id}/generate-i18n` → `infer_question_i18n_from_zh`（AI 翻译）→ 更新 title_en/content_en/title_zh_tw/content_zh_tw。
7. **难度反馈**：`POST /questions/{id}/difficulty-feedback` → 校验用户在该题有正确提交 → 写入 `question_difficulty_feedback`。

**逻辑链**：题目 CRUD 依赖教师权限；列表/详情依赖仓库 + 动态难度服务 + SQL 解析；AI 生成依赖知识点 ID 与 AI 配置；多语言依赖 AI 翻译接口。

---

### 4. 判题与 AI 提示（check-sql）

1. **前置**：根据题目 `schema_preview` 在判题库中建表并插入示例数据（`core/judge_setup.py`：`generate_init_sql_from_schema_preview`、`execute_setup_sql`）。
2. **执行**：学生 SQL 与标准答案 SQL 经 `SQLJudgeService._check_sql_safety`（仅允许 SELECT）→ `execute_sql_safely` 分别执行 → 得到两个结果集。
3. **标准化**：`_normalize_row` 对每行：数值转字符串，字符串 strip 并小写（避免 name='Laptop' 与 'laptop' 误判）；若有 ORDER BY 则按行序比较，否则按行集比较。
4. **对比**：`compare_results_ordered` 或 `compare_results_unordered` → 返回是否一致及错误信息。
5. **支架与 AI**：根据历史失败次数与用户整体表现计算 `hint_level`（`core/scaffolding.py`）→ 调用 `get_sql_hint`（`core/ai_service.py`）生成提示（传入 is_correct、error_message、language 等）。
6. **落库**：写入 `submissions`；若正确则计算经验并更新用户 `total_experience`；写入 3 条 `chat_messages`（system：本轮结果；user：学生 SQL；assistant：AI 提示）。

**逻辑链**：schema_preview → 建表 → 执行学生/标准 SQL → 标准化与对比 → AI 提示 → 提交记录 + 经验 + 对话历史。

---

### 5. 对话（chat）

1. **历史**：`GET /ai/chat/messages` → `ChatRepository.list_messages` → 按 user_id、question_id 取最近 N 条。
2. **发送**：`POST /ai/chat` → 取题目、最近提交、失败次数、历史消息 → `chat_with_teacher`（AI）→ 写入 user 与 assistant 两条消息 → 返回助手回复。
3. **清除**：`DELETE /ai/chat/messages` → `delete_messages_by_user_question`。

**逻辑链**：题目 + 提交历史 + 对话历史 → AI 多轮对话 → 写回 chat_messages。

---

## 三、前端逻辑链

### 1. 请求与认证

1. **封装**：`utils/request.ts` 统一 baseURL、超时、请求头；响应中若 401 则清除 Token 并跳转登录。
2. **Token**：登录后存 `token`、`refresh_token`；请求头 `Authorization: Bearer <token>`；可选在请求拦截器中用 refresh_token 换新 token。
3. **鉴权**：`utils/auth.ts` 中 `ensureAuthed()`、`requireTeacher()` 等，用于页面进入前校验与跳转。

**逻辑链**：登录 → 存 Token → 后续请求自动带 Token → 401 时跳转登录。

---

### 2. 登录页

1. **Tab**：登录 / 注册 / 注销账户。
2. **注册**：先请求 `/auth/code` → 用户填验证码与密码 → `POST /auth/register` → 成功后切回登录 Tab。
3. **登录**：`POST /auth/login` → 存 Token 与用户信息 → `reLaunch` 到首页（或根据角色到教师端）。
4. **语言**：`ai_language` 存本地，页面文案与导航栏标题随 `languageIndex` 切换。

**逻辑链**：验证码 → 注册/登录 → Token 与用户信息 → 跳转首页/教师端。

---

### 3. 学生练习页

1. **初始化**：`onShow` 时 `getProfile`、`getQuestions`；恢复上次选题与 `ai_language`；若有当前题目且语言非 zh-CN 且缺翻译，则请求 `generateQuestionI18n` 并更新本地题目列表/详情。
2. **选题**：下拉选择、题号跳转（`getQuestion` 拉详情）、随机 — 均更新 `currentQuestion`，并拉取题目详情（含 schema_preview）。
3. **题目展示**：`displayQuestion` 优先用题目详情；标题/内容用 `localizedTitle`/`localizedContent`（按 ai_language 取 title_en 等，缺则占位或自动触发 generate-i18n）。
4. **提交 SQL**：`POST /ai/check-sql`（带 question_id、student_sql、language、challenge_mode）→ 根据返回 is_correct 展示结果与 AI 提示；若正确且首次则弹难度反馈并可提交 `difficulty-feedback`。
5. **对话**：`loadChat` 拉历史；输入框发送 `POST /ai/chat`；清除历史调用 `DELETE /ai/chat/messages`。
6. **限时挑战**：本地倒计时，结束时提示；若在限时内提交正确则 challenge_mode=true 可获额外经验。

**逻辑链**：Profile + 题目列表 → 选题 → 题目详情与多语言 → 写 SQL → check-sql（建表→判题→AI 提示）→ 提交记录与对话 → 可选难度反馈与限时奖励。

---

### 4. 教师端

1. **初始化**：`onShow` 时 `getProfile`、`requireTeacher`；`getKnowledgePoints`；`getQuestions`。
2. **知识点**：下拉显示多语言标签（如「入门 · AS 别名」），选后可选生成数量，点「AI 生成题目」调用 `generate-by-ai`，刷新题目列表。
3. **题目编辑**：选择题目后拉 `getQuestion` 填表单；保存调用 create/update；删除前二次确认再 DELETE。
4. **多语言**：当前题目可点「补全多语言」调用 `generate-i18n`，刷新题目与表单；列表标题/内容用 `localizedTitle`/`localizedContent`。

**逻辑链**：教师校验 → 知识点 + 题目列表 → 新建/编辑/删除题目 或 AI 生成 → 可选补全多语言。

---

## 四、关键数据流小结

| 场景 | 后端入口 | 核心依赖 | 前端入口 |
|------|----------|----------|----------|
| 登录 | POST /auth/login | UserRepository, AuthHandler | pages/login 提交表单 |
| 题目列表 | GET /questions/ | QuestionRepository, 难度/限时/列名推断 | 学生/教师页 onShow |
| 判题 | POST /ai/check-sql | judge_setup, SQLJudgeService, get_sql_hint, SubmissionRepository | 学生页提交 SQL 按钮 |
| 对话 | POST /ai/chat | chat_with_teacher, ChatRepository | 学生页对话发送 |
| 多语言题目 | POST /questions/{id}/generate-i18n | infer_question_i18n_from_zh | 学生页缺翻译时自动；教师页「补全多语言」 |

按上述顺序从数据库到路由再到前端页面实现，即可复现「从 0 到上线」的完整逻辑链。

---

*文档版本：与当前代码一致。*
