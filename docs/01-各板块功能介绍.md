# SQL 智能教学系统 — 各板块功能介绍

本文档按前后端模块列出各板块功能，便于新人快速了解系统能力与入口。

---

## 一、后端（FastAPI）

### 1. 认证与用户（`/auth`）

| 功能 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 发送邮箱验证码 | GET | `/auth/code?email=xxx` | 注册/找回时发送 6 位验证码到邮箱 |
| 用户注册 | POST | `/auth/register` | 校验验证码后创建账号，可选教师邀请码 |
| 用户登录 | POST | `/auth/login` | 返回 access_token / refresh_token |
| 刷新 Token | POST | `/auth/refresh` | 用 refresh_token 换新 access_token |
| 获取当前用户信息 | GET | `/auth/profile` | 需 Bearer Token，返回用户信息与等级经验 |
| 注销账户 | POST | `/auth/delete-account` | 校验邮箱与密码后永久删除账号 |

**相关代码**：`routers/auth_router.py`、`repository/user_repo.py`、`core/auth.py`、`core/experience_service.py`（等级经验）。

---

### 2. 题目管理（`/questions`）

| 功能 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取题目列表 | GET | `/questions/?skip=0&limit=100` | 分页，含动态难度与限时建议 |
| 获取题目详情 | GET | `/questions/{question_id}` | 单题详情，无 schema_preview 时自动生成 |
| 创建题目 | POST | `/questions/` | 需教师权限；难度/限时/结果列名可留空由系统推断 |
| 更新题目 | PUT | `/questions/{question_id}` | 需教师权限 |
| 删除题目 | DELETE | `/questions/{question_id}` | 需教师权限，级联删除相关提交 |
| 获取知识点列表 | GET | `/questions/knowledge-points` | 需教师权限，入门/进阶/精通多语言 |
| 按知识点 AI 生成题目 | POST | `/questions/generate-by-ai` | 需教师权限，1～5 道 |
| 生成题目多语言题面 | POST | `/questions/{id}/generate-i18n` | 已登录即可，为题目生成英/繁体 |
| 生成表结构预览 | POST | `/questions/{id}/generate-schema-preview` | 需教师权限，AI 生成 schema_preview |
| 推断结果列名 | POST | `/questions/infer-output-columns` | 需教师权限，从标准答案 SQL 解析列名 |
| 提交难度反馈 | POST | `/questions/{id}/difficulty-feedback` | 学生正确完成后可对题目难度打分 1～10 |

**相关代码**：`routers/question.py`、`repository/question_repo.py`、`core/sql_knowledge_points.py`、`core/ai_question_generator.py`、`core/sql_parser.py`、`core/difficulty_service.py`。

---

### 3. AI 判题与对话（`/ai`）

| 功能 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 检查 SQL 是否正确 | POST | `/ai/check-sql` | 执行学生 SQL 与标准答案，对比结果；自动建表；返回 AI 提示与是否正确 |
| 获取对话历史 | GET | `/ai/chat/messages?question_id=xx&limit=50` | 当前用户在该题下的聊天记录 |
| 发送对话消息 | POST | `/ai/chat` | 与 AI 教师多轮追问 |
| 清除对话历史 | DELETE | `/ai/chat/messages?question_id=xx` | 清除当前用户在该题下的所有消息 |
| SQL 提示（仅测试） | POST | `/ai/sql-hint` | 仅调用 AI 提示，不判题、不记提交 |

**相关代码**：`routers/ai.py`、`core/sql_judge.py`、`core/ai_service.py`、`core/judge_setup.py`、`core/scaffolding.py`、`repository/submission_repo.py`、`repository/chat_repo.py`。

---

### 4. 其他

| 功能 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 健康检查 | GET | `/` | 返回运行中提示 |
| 邮件测试 | GET | `/mail/test?email=xxx` | 依赖 `get_mail`，发送测试邮件 |

**相关代码**：`main.py`、`dependencies.py`、`core/mail.py`。

---

## 二、前端（uni-app Vue3）

### 1. 登录页（`pages/login/index`）

- **功能**：登录、注册、注销账户；顶部语言切换（简体/English/繁體）。
- **接口**：`/auth/code`、`/auth/register`、`/auth/login`、`/auth/delete-account`。
- **说明**：验证码倒计时、Token 存本地、登录后跳转首页或教师端（按角色）。

---

### 2. 学生练习页（`pages/index/index`）

- **功能**：选题（下拉/题号跳转/随机）、查看题目与表结构预览、编写 SQL、提交判题、限时挑战、与 AI 教师对话、清除对话、难度反馈弹窗、语言切换。
- **接口**：`/auth/profile`、`/questions/`、`/questions/{id}`、`/ai/check-sql`、`/ai/chat/messages`、`/ai/chat`、`/ai/chat/messages`（DELETE）、`/questions/{id}/difficulty-feedback`、`/questions/{id}/generate-i18n`（缺翻译时自动调用）。
- **说明**：题目/知识点多语言；缺英文或繁体时先显示“翻译生成中”并自动请求 generate-i18n。

---

### 3. 教师端（`pages/teacher/index`）

- **功能**：题目列表、新建/编辑/删除题目、按知识点 AI 生成题目、为当前题目补全多语言、语言切换。
- **接口**：`/auth/profile`、`/questions/`、`/questions/{id}`、`/questions/`（POST/PUT/DELETE）、`/questions/knowledge-points`、`/questions/generate-by-ai`、`/questions/{id}/generate-i18n`。

---

## 三、数据与配置要点

- **数据库**：MySQL（主库），判题时按题目 `schema_preview` 在会话中建表/插数据再执行 SQL。
- **认证**：JWT access_token + refresh_token，请求头 `Authorization: Bearer <token>`。
- **多语言**：前端存 `ai_language`（zh-CN / en / zh-TW），题目与知识点按此展示；判题时传 `language` 给 AI 提示与对话。
- **判题**：仅允许 SELECT；结果对比时字符串列已做去空格与小写归一化，避免 `name='Laptop'` 与 `'laptop'` 误判。

---

*文档版本：与当前代码一致，按模块与路由整理。*
